<!doctype html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SoftLayer API Examples, implementations, and release notes.">
    <meta name="author" content="SoftLayer">

    <title>Sub-Organization Billing Detail - https://softlayer.github.io/</title>
    <link rel="canonical" href="https://softlayer.github.io/article/sub-org-billing-detail/">
        <link href="https://softlayer.github.io/css/main.css" rel="stylesheet">
    <link href="https://softlayer.github.io/css/bootstrap.css" rel="stylesheet">
    <link href="https://softlayer.github.io/css/fa-svg-with-js.css" rel="stylesheet">
    <link href="https://softlayer.github.io/css/custom.css" rel="stylesheet">
    <link href="https://softlayer.github.io/css/highlight/solarized_dark.css" rel="stylesheet">

    <script src="https://softlayer.github.io/js/highlight.pack.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="shortcut icon" href="https://softlayer.github.io/img/favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Lato" />
            

    <script src="https://softlayer.github.io/js/jquery-3.3.1.min.js"></script> 
    <script src="https://softlayer.github.io/js/sldn.js"></script>
    <script src="https://softlayer.github.io/js/fontawesome-all.js"></script>

    
	<script>
		$(document).ready(function() {
			$('table').addClass("table table-hover table-striped")
		})
	</script>
    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-88235803-1', 'auto');
ga('send', 'pageview');
</script>

</head>

<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle Navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://softlayer.github.io/">SoftLayer API</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    
                        <li><a href="https://softlayer.github.io/article/">Articles</a></li>
                    
                        <li><a href="https://softlayer.github.io/reference/softlayerapi">Documentation</a></li>
                    
                        <li><a href="https://softlayer.github.io/go/">Go</a></li>
                    
                        <li><a href="https://softlayer.github.io/java/">Java</a></li>
                    
                        <li><a href="https://softlayer.github.io/perl/">Perl</a></li>
                    
                        <li><a href="https://softlayer.github.io/python/">Python</a></li>
                    
                        <li><a href="https://softlayer.github.io/rest/">Rest</a></li>
                    
                        <li><a href="https://softlayer.github.io/ruby/">Ruby</a></li>
                    
                        <li><a href="https://softlayer.github.io/tools/">Tools</a></li>
                    

                    
                </ul>
                <div id="custom-search-input" class="pull-right">
                  <form class="navbar-form" role="search" method="get" action="https://www.bing.com/">
                    <div class="input-group col-md-12">
                      <input type="text" class="form-control input-md" placeholder="Search" name="q" id="srch-term">
                      <input type="hidden" name="q1" value="site:softlayer.github.io" />
                      <div class="input-group-btn">
                        <button class="btn btn-info" type="submit">
                          <i class="glyphicon glyphicon-search"></i>
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
            </div>
        </div>
    </nav>

<div class="container">
    <div class="row">
    
        <div class="col-md-3">
            <div style="word-wrap: break-word;"> 
                <h4>July 23, 2018<br></h4>
            </div>
        </div>
        <div class="col-md-9">
                <strong>Tags <span class="fa fa-tags"/></strong>
                
                    <a class="label label-danger" href="https://softlayer.github.io/tags/article">article</a>
                
                    <a class="label label-danger" href="https://softlayer.github.io/tags/sldn">sldn</a>
                
                    <a class="label label-danger" href="https://softlayer.github.io/tags/python">python</a>
                          
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-md-12">
            <div class="well well-sm release-note" style="word-wrap: break-word;">
                <h3>Sub-Organization Billing Detail<br> <small>This tutorial walks you through accessing the steps required to access detailed billing data across sub-organization accounts using a specified date and time range.</small></h3>
                
                
                
                

<h1 id="sub-org-billing-detail">Sub-org Billing Detail</h1>

<p>This tutorial walks you through accessing the steps required to access detailed billing data across sub-organization accounts using a specified date and time range.</p>

<h2 id="objectives">Objectives</h2>

<p>Understand how to use multiple API services and methods to access detailed billing data for all sub organization accounts for a specified time and date range.</p>

<h2 id="services-used">Services used</h2>

<p>This tutorial uses the following technologies:
* <a href="http://softlayer-python.readthedocs.io/en/latest/">SoftLayer Python Library</a>
* <a href="https://softlayer.github.io/reference/services/SoftLayer_Account">Account Service</a>
* <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Invoice/">Billing_Invoice Service</a>
* <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Invoice_Item/">Billing_Invoice_Item Service</a>
* <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Item/">Billing_item Service</a></p>

<h2 id="architecture">Architecture</h2>

<p>Accounts (refered to in this document as a sub account) can be owned by a Brand Account, which is the top level
account type for an organization which can enable sub-organizational level billing.  The API Key for a Brand Account
has access billing data for it&rsquo;s sub accounts. This tutorial demonstrates how to leverage Account, Invoice and Billing
API&rsquo;s to identify invoices accross the multiple sub accounts owned by an organization for a specific range of
dates.  For each invoice, a list of top level billing items are  retreived, such as the billing data for a single
virtual machine.   These top level items, often have detailed sub-billing items such as memory, disk, or cpu which
are also retreived.</p>

<h2 id="install-softlayer-python-library">Install SoftLayer Python Library</h2>

<ul>
<li><a href="https://github.com/softlayer/softlayer-python/blob/master/README.rst">SoftLayer API Python Client Installation</a></li>
</ul>

<h2 id="obtain-a-list-of-invoices-for-all-owned-sub-accounts">Obtain a list of invoices for all owned Sub Accounts</h2>

<p>Using the <a href="https://softlayer.github.io/reference/services/SoftLayer_Account/getObject">getObject</a> method of
the <a href="https://softlayer.github.io/reference/services/SoftLayer_Account">Account</a> class and a nested account mask you can return a list of invoices for all brands owned accounts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ownedBrands <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Account&#39;</span>]<span style="color:#f92672">.</span>getObject(mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;ownedBrands.allOwnedAccounts.invoices&#34;</span>)</code></pre></div>
<p>There are several types of invoices which will be returned, for this example the typical invoice type that would be of interest
 is the &ldquo;RECURRING&rdquo; type, which includes all the monthly recurring and hourly usage charges incurred on that invoice.</p>

<p>Invoice Types:
* &ldquo;NEW&rdquo; typeCode signifies an invoice for new service.
* &ldquo;RECURRING&rdquo; invoices are generated on an accounts anniversary billing date for monthly services.
* &ldquo;ONE-TIME-CHARGE&rdquo; invoices are generated when one-time charges are applied to an account.
* &ldquo;CREDIT&rdquo; invoices are generated whenever IBM applies a credit against an account&rsquo;s balance.</p>

<p>The list of invoices should then be filtered to include just the specific type of invoices and dates ranges to be
evaluated.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ownedBrands <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Account&#39;</span>]<span style="color:#f92672">.</span>getObject(mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;ownedBrands.allOwnedAccounts.invoices&#34;</span>)

startDate <span style="color:#f92672">=</span>  <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;2018-04-01T00:00:00-06:00&#34;</span>
endDate <span style="color:#f92672">=</span>  <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;2018-05-01T11:59:59-06:00&#34;</span>

invoiceType <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;RECURRING&#34;</span>
invoiceList<span style="color:#f92672">=</span>[]

<span style="color:#66d9ef">for</span> brand <span style="color:#f92672">in</span> ownedBrands[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;ownedBrands&#39;</span>]:
    <span style="color:#66d9ef">for</span> account <span style="color:#f92672">in</span> brand[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;allOwnedAccounts&#39;</span>]:
        <span style="color:#66d9ef">for</span> invoice <span style="color:#f92672">in</span> account[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;invoices&#39;</span>]:
            invoiceCreateDate <span style="color:#f92672">=</span> invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;createDate&#39;</span>]
            <span style="color:#66d9ef">if</span> (invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;typeCode&#39;</span>] <span style="color:#f92672">==</span> invoiceType) \
                    <span style="color:#f92672">and</span> (dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(invoiceCreateDate) <span style="color:#f92672">&gt;</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(startDate)
                         <span style="color:#f92672">and</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(invoiceCreateDate) <span style="color:#f92672">&lt;</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(endDate)):
                invoiceInfo <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice&#39;</span>]<span style="color:#f92672">.</span>getObject(id<span style="color:#f92672">=</span>invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id&#39;</span>],
                    mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;id,createDate,typeCode,invoiceTotalAmount,invoiceTotalRecurringAmount,invoiceTopLevelItemCount&#34;</span>)
                invoiceList<span style="color:#f92672">.</span>append(invoiceInfo)

<span style="color:#66d9ef">print</span> (invoiceList)</code></pre></div>
<h2 id="access-invoice-detail">Access invoice detail</h2>

<p>Using the list of invoices returned, use the <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Invoice/getInvoiceTopLevelItems/">getInvoiceTopLevelItems</a>
method from the <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Invoice">Billing_Invoice</a> class to obtain the list of top level items being billed on the invoice specified.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">for</span> invoice <span style="color:#f92672">in</span> InvoiceList:
    topLevelItems <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice&#39;</span>]<span style="color:#f92672">.</span>getInvoiceTopLevelItems(id<span style="color:#f92672">=</span>invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id&#39;</span>])    
    <span style="color:#66d9ef">print</span> (topLevelItems)</code></pre></div>
<h2 id="access-sub-item-details">Access sub item details</h2>

<p>If additional billing detail is desired for topLevelItems, many items have associated children which have billing details
that make up to the top level item such as memory, storage, or disk.   To access, the details use  <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Invoice_Item/getNonZeroAssociatedChildren">getNonZeroAssociatedChildren</a> method in the <a href="https://softlayer.github.io/reference/services/SoftLayer_Billing_Invoice_Item">Billing_Invoice_Item</a>
class, by passing the id received from the getInvoiceTopLevelItems call.  The method only returns those associated children with a non-zero cost.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">nonZeroAssociatedChildren <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice_Item&#39;</span>]<span style="color:#f92672">.</span>getNonZeroAssociatedChildren(id<span style="color:#f92672">=</span>topLevelItemId)</code></pre></div>
<h2 id="sample-script">Sample script</h2>

<p>The following sample script creates a .csv file of all the billing level detail for each owned sub account for the dates specified.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> SoftLayer<span style="color:#f92672">,</span> argparse<span style="color:#f92672">,</span> csv<span style="color:#f92672">,</span>logging<span style="color:#f92672">,</span>time
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="color:#f92672">import</span> dateutil.parser

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getDescription</span>(categoryCode, detail):
    <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> detail:
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;categoryCode&#39;</span> <span style="color:#f92672">in</span> item:
            <span style="color:#66d9ef">if</span> item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;categoryCode&#39;</span>]<span style="color:#f92672">==</span>categoryCode:
                <span style="color:#66d9ef">return</span> item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;description&#39;</span>]
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Not Found&#34;</span>

client <span style="color:#f92672">=</span> SoftLayer<span style="color:#f92672">.</span>Client()

startDate <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;2018-07-01T00:00:00&#39;</span>
endDate <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;2018-07-31T23:59:59&#39;</span>
outputname <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;billing-export.csv&#39;</span>


<span style="color:#75715e">## OPEN CSV FILE FOR OUTPUT</span>
outfile <span style="color:#f92672">=</span> open(outputname, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;w&#39;</span>)
csvwriter <span style="color:#f92672">=</span> csv<span style="color:#f92672">.</span>writer(outfile, delimiter<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>, quotechar<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#34;&#39;</span>, quoting<span style="color:#f92672">=</span>csv<span style="color:#f92672">.</span>QUOTE_ALL)

fieldnames <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Invoice_Date&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Account_Id&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Invoice_Number&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;BillingItemId&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;InstanceType&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hostName&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Category&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Description&#39;</span>,
             <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Hours&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Hourly_Rate&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;RecurringCharge&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;InvoiceTotal&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;InvoiceRecurring&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Type&#39;</span>]
csvwriter <span style="color:#f92672">=</span> csv<span style="color:#f92672">.</span>DictWriter(outfile, delimiter<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;,&#39;</span>, fieldnames<span style="color:#f92672">=</span>fieldnames)
csvwriter<span style="color:#f92672">.</span>writerow(dict((fn, fn) <span style="color:#66d9ef">for</span> fn <span style="color:#f92672">in</span> fieldnames))


<span style="color:#75715e">#</span>
<span style="color:#75715e"># GET LIST OF INVOICES FOR ALL BRAND OWNED ACCOUNTS</span>
<span style="color:#75715e">#</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Looking up invoices for brand....&#34;</span>)
ownedBrands <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Account&#39;</span>]<span style="color:#f92672">.</span>getObject(mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;ownedBrands.allOwnedAccounts.invoices&#34;</span>)

<span style="color:#75715e"># FILTER INVOICES FOR INVOICETYPE AND DATE RANGE REQUESTED</span>

invoiceType <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;RECURRING&#34;</span>
invoiceList<span style="color:#f92672">=</span>[]

<span style="color:#66d9ef">for</span> brand <span style="color:#f92672">in</span> ownedBrands[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;ownedBrands&#39;</span>]:
    <span style="color:#66d9ef">for</span> account <span style="color:#f92672">in</span> brand[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;allOwnedAccounts&#39;</span>]:
        <span style="color:#66d9ef">for</span> invoice <span style="color:#f92672">in</span> account[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;invoices&#39;</span>]:
            invoiceCreateDate <span style="color:#f92672">=</span> invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;createDate&#39;</span>]
            <span style="color:#66d9ef">if</span> (invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;typeCode&#39;</span>] <span style="color:#f92672">==</span> invoiceType) \
                    <span style="color:#f92672">and</span> (dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(invoiceCreateDate) <span style="color:#f92672">&gt;</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(startDate)
                         <span style="color:#f92672">and</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(invoiceCreateDate) <span style="color:#f92672">&lt;</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(endDate)):
                invoiceInfo <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice&#39;</span>]<span style="color:#f92672">.</span>getObject(id<span style="color:#f92672">=</span>invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id&#39;</span>],
                    mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;id,createDate,typeCode,invoiceTotalAmount,invoiceTotalRecurringAmount,invoiceTopLevelItemCount&#34;</span>)
                invoiceList<span style="color:#f92672">.</span>append(invoiceInfo)


<span style="color:#75715e">## OBTAIN TOP LEVEL DETAIL FROM EACH INVOICE</span>

<span style="color:#66d9ef">print</span> ()
<span style="color:#66d9ef">print</span> (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;{:&lt;35} {:&lt;15} {:&lt;15} {:&gt;8} {:&gt;16} {:&gt;16} {:&gt;16} {:&lt;15}&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Invoice Date /&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Account&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Invoice&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Items&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Recurring Charge&#34;</span>,  <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Invoice Amount&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Type&#34;</span>))
<span style="color:#66d9ef">print</span> (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;{:&lt;35} {:&lt;15} {:&lt;15} {:&gt;8} {:&gt;16} {:&gt;16} {:&gt;16} {:&lt;15}&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;==============&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;=======&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;=======&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;=====&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;================&#34;</span>,  <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;==============&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;====&#34;</span>))
<span style="color:#66d9ef">for</span> invoice <span style="color:#f92672">in</span> invoiceList:
    invoiceId <span style="color:#f92672">=</span> invoice[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id&#39;</span>]
    invoiceInfo <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice&#39;</span>]<span style="color:#f92672">.</span>getObject(id<span style="color:#f92672">=</span>invoiceId,mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;accountId, id,createDate,typeCode,invoiceTotalAmount,invoiceTotalRecurringAmount,invoiceTopLevelItemCount&#34;</span>)
    accountId <span style="color:#f92672">=</span> invoiceInfo[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;accountId&#39;</span>]
    invoiceDate <span style="color:#f92672">=</span> invoiceInfo[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;createDate&#39;</span>][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">10</span>]
    invoiceTotalAmount <span style="color:#f92672">=</span> float(invoiceInfo[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;invoiceTotalAmount&#39;</span>])
    invoiceTotalRecurringAmount <span style="color:#f92672">=</span> float(invoiceInfo[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;invoiceTotalRecurringAmount&#39;</span>])
    invoiceType <span style="color:#f92672">=</span> invoiceInfo[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;typeCode&#39;</span>]
    totalItems<span style="color:#f92672">=</span>invoiceInfo[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;invoiceTopLevelItemCount&#39;</span>]

    <span style="color:#75715e"># PRINT INVOICE SUMMARY LINE</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;{:35} {:&lt;15} {:&lt;15} {:&gt;8} {:&gt;16} {:&gt;16,.2f} {:&gt;16,.2f} {:&lt;15}&#39;</span><span style="color:#f92672">.</span>format(invoiceDate,
                                                                          accountId, invoiceId, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span>,
                                                                          totalItems,
                                                                          invoiceTotalAmount,
                                                                          invoiceTotalRecurringAmount, invoiceType))

    limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e">## set limit of record t</span>
    <span style="color:#66d9ef">for</span> offset <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,totalItems,limit):
        <span style="color:#75715e">#print (&#34;Lookup at Offset %s&#34; % offset)</span>
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
        Billing_Invoice <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice&#39;</span>]<span style="color:#f92672">.</span>getInvoiceTopLevelItems(id<span style="color:#f92672">=</span>invoiceId, limit<span style="color:#f92672">=</span>limit, offset<span style="color:#f92672">=</span>offset,
                                mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id, billingItemId, categoryCode, hostName, domainName, description, createDate, totalRecurringAmount,hourlyRecurringFee&#39;</span>)
        count<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
        <span style="color:#75715e"># ITERATE THROUGH DETAIL</span>
        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> Billing_Invoice:
            billingItemId <span style="color:#f92672">=</span> item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;billingItemId&#39;</span>]
            category <span style="color:#f92672">=</span> item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;categoryCode&#34;</span>]

            <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hostName&#39;</span> <span style="color:#f92672">in</span> item:
                hostName <span style="color:#f92672">=</span> item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hostName&#39;</span>]<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">+</span>item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;domainName&#39;</span>]
            <span style="color:#66d9ef">else</span>:
                hostName <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Unnamed Device&#34;</span>

            recurringFee <span style="color:#f92672">=</span> float(item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;totalRecurringAmount&#39;</span>])

            <span style="color:#75715e">#IF Monthly calculate hourly rate and total hours</span>
            <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hourlyRecurringFee&#39;</span> <span style="color:#f92672">in</span> item:
                instanceType <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Hourly&#34;</span>
                associated_children<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;</span>
                <span style="color:#66d9ef">while</span> associated_children <span style="color:#f92672">is</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;</span>:
                    <span style="color:#66d9ef">try</span>:
                        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.5</span>)
                        associated_children <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice_Item&#39;</span>]<span style="color:#f92672">.</span>getNonZeroAssociatedChildren(id<span style="color:#f92672">=</span>item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id&#39;</span>],mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;hourlyRecurringFee&#34;</span>)
                    <span style="color:#66d9ef">except</span> SoftLayer<span style="color:#f92672">.</span>SoftLayerAPIError <span style="color:#66d9ef">as</span> e:
                        logging<span style="color:#f92672">.</span>warning(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;getNonZeroAssociatedChildren(): </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (e<span style="color:#f92672">.</span>faultCode, e<span style="color:#f92672">.</span>faultString))
                        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">5</span>)
                <span style="color:#75715e">#calculate total hourlyRecurringFree from associated childrent</span>

                hourlyRecurringFee <span style="color:#f92672">=</span> float(item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hourlyRecurringFee&#39;</span>]) <span style="color:#f92672">+</span> sum(float(child[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hourlyRecurringFee&#39;</span>]) <span style="color:#66d9ef">for</span> child <span style="color:#f92672">in</span> associated_children)
                <span style="color:#66d9ef">if</span> hourlyRecurringFee <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
                    hours <span style="color:#f92672">=</span> round(float(recurringFee) <span style="color:#f92672">/</span> hourlyRecurringFee)
                <span style="color:#66d9ef">else</span>:
                    hours<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
            <span style="color:#66d9ef">else</span>:
                instanceType <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Monthly/Other&#34;</span>
                hourlyRecurringFee <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
                hours <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

            <span style="color:#66d9ef">if</span> category<span style="color:#f92672">==</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;storage_service_enterprise&#34;</span> <span style="color:#f92672">or</span> category<span style="color:#f92672">==</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;performance_storage_iscsi&#34;</span>:
                billing_detail<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;</span>
                <span style="color:#66d9ef">while</span> billing_detail <span style="color:#f92672">is</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;</span>:
                    <span style="color:#66d9ef">try</span>:
                        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
                        billing_detail <span style="color:#f92672">=</span> client[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Billing_Invoice_Item&#39;</span>]<span style="color:#f92672">.</span>getChildren(id<span style="color:#f92672">=</span>item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;id&#39;</span>], mask<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;description,categoryCode,product&#34;</span>)
                    <span style="color:#66d9ef">except</span> SoftLayer<span style="color:#f92672">.</span>SoftLayerAPIError <span style="color:#66d9ef">as</span> e:
                        logging<span style="color:#f92672">.</span>warning(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (e<span style="color:#f92672">.</span>faultCode, e<span style="color:#f92672">.</span>faultString))

                <span style="color:#66d9ef">if</span> category<span style="color:#f92672">==</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;storage_service_enterprise&#34;</span>:
                    iops<span style="color:#f92672">=</span>getDescription(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;storage_tier_level&#34;</span>, billing_detail)
                    storage<span style="color:#f92672">=</span>getDescription(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;performance_storage_space&#34;</span>,billing_detail)
                    snapshot<span style="color:#f92672">=</span>getDescription(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;storage_snapshot_space&#34;</span>, billing_detail)
                    <span style="color:#66d9ef">if</span> snapshot<span style="color:#f92672">==</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Not Found&#34;</span>:
                        description<span style="color:#f92672">=</span>storage<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span>iops<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span>
                    <span style="color:#66d9ef">else</span>:
                        description<span style="color:#f92672">=</span>storage<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span>iops<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34; with &#34;</span><span style="color:#f92672">+</span>snapshot
                <span style="color:#66d9ef">else</span>:
                    iops<span style="color:#f92672">=</span>getDescription(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;performance_storage_iops&#34;</span>, billing_detail)
                    storage<span style="color:#f92672">=</span>getDescription(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;performance_storage_space&#34;</span>, billing_detail)
                    description<span style="color:#f92672">=</span>storage<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span>iops
            <span style="color:#66d9ef">else</span>:
                description<span style="color:#f92672">=</span>item[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;description&#39;</span>]
                description <span style="color:#f92672">=</span> description<span style="color:#f92672">.</span>replace(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34; &#34;</span>)
            <span style="color:#75715e"># BUILD CSV OUTPUT &amp; WRITE ROW</span>
            row <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Invoice_Date&#39;</span>: invoiceDate,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Account_Id&#39;</span>: accountId,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Invoice_Number&#39;</span>: invoiceId,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;BillingItemId&#39;</span>: billingItemId,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;InstanceType&#39;</span>: instanceType,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;hostName&#39;</span>: hostName,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Category&#39;</span>: category,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Description&#39;</span>: description,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Hours&#39;</span>: hours,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Hourly_Rate&#39;</span>: round(hourlyRecurringFee,<span style="color:#ae81ff">3</span>),
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;RecurringCharge&#39;</span>: round(recurringFee,<span style="color:#ae81ff">2</span>),
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;InvoiceTotal&#39;</span>: invoiceTotalAmount,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;InvoiceRecurring&#39;</span>: invoiceTotalRecurringAmount,
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Type&#39;</span>: invoiceType
                    }
            csvwriter<span style="color:#f92672">.</span>writerow(row)
            <span style="color:#75715e">#print(row)</span>
<span style="color:#75715e">##close CSV File</span>
outfile<span style="color:#f92672">.</span>close()</code></pre></div>
            </div>
        </div>

    </div>
    <hr>
    <div class="row">
            
        <div class="col-md-6">
            
<div class="panel panel-default">
    <div class="panel-heading" style="padding: 2px 15px;">
        <h4>More Documentation</h4>
    </div>
    <div class="panel-body">
        <a href="https://softlayer.github.com/reference/softlayerapi"><i class="fa fa-link"></i> SoftLayer API Reference<br></a>
        <a href="https://github.com/softlayer/softlayer-java"><i class="fab fa-github"></i> softlayer-java<br></a>
        <a href="https://github.com/softlayer/softlayer-api-perl-client"><i class="fab fa-github"></i> softlayer-perl<br></a>
        <a href="https://github.com/softlayer/softlayer-api-php-client"><i class="fab fa-github"></i> softlayer-php<br></a>
        <a href="https://github.com/softlayer/softlayer-python"><i class="fab fa-github"></i> softlayer-python<br></a>
        <a href="https://github.com/softlayer/softlayer-ruby"><i class="fab fa-github"></i> softlayer-ruby<br></a>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading text-center" style="padding: 2px 15px;">
      <a href="https://www.facebook.com/IBMBluemixIaaS/"><i class="fab fa-facebook-square" alt="facebook"></i> </a>
      <a href="https://twitter.com/IBMBluemixIaaS"><i class="fab fa-twitter" alt="twitter"></i> </a>
      <a href="http://www.linkedin.com/company/softlayer-technologies-inc-" alt="linked-in"><i class="fab fa-linkedin"></i> </a>
      <a href="https://github.com/softlayer/softlayer.github.io"><i class="fab fa-github" alt="github"></i> </a>

    </div>
</div>

        </div>
        <div class="col-md-6">
            <div class="well well-sm" style="word-wrap: break-word;"> 
                <strong>Feedback? <span class="fa fa-comment"/></strong>
                    <p>
                        We would love to hear it<br>
                        <a class="" href="https://github.com/softlayer/api_examples/issues/new?title=Feedback%20for%20article%20-%20Sub-Organization%20Billing%20Detail&body=Feedback+regarding%3A%20https%3a%2f%2fsoftlayer.github.io%2farticle%2fsub-org-billing-detail%2f"><span class="fa fa-github-square"/> Open an issue</a>
                    </p>
            </div>
        </div>

    </div>
        <footer>
            <div class="row">
                <hr>
                <div class="col-sm-12">
                    <p>&copy; SoftLayer 2015<br>
                    Built with <a href="https://github.com/spf13/hugo">Hugo</a></p>
                </div>
            </div>
        </footer>
</div>

    <script src="https://softlayer.github.io/js/jquery.js"></script>
    <script src="https://softlayer.github.io/js/bootstrap.js"></script>
</body>
</html>

