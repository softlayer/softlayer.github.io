<!doctype html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SoftLayer API Examples, implementations, and release notes.">
    <meta name="author" content="SoftLayer">

    <title>Object Storage Uploader - https://sldn.softlayer.com/</title>
    <link rel="canonical" href="https://sldn.softlayer.com/python/swiftUploader/">
        <link href="https://sldn.softlayer.com/css/main.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/bootstrap.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/custom.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/monokai.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/highlight/solarized_dark.css" rel="stylesheet">

    <script src="https://sldn.softlayer.com/js/highlight.pack.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="shortcut icon" href="https://sldn.softlayer.com/img/favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Lato" />
            

    <script src="https://sldn.softlayer.com/js/jquery-3.3.1.min.js"></script> 
    <script src="https://sldn.softlayer.com/js/sldn.js"></script>


    <link href="https://sldn.softlayer.com/fontawesome/css/fontawesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://sldn.softlayer.com/fontawesome/css/brands.min.css" rel="stylesheet" type="text/css">
    <link href="https://sldn.softlayer.com/fontawesome/css/solid.min.css" rel="stylesheet" type="text/css">
    
    <script defer src="https://sldn.softlayer.com/fontawesome/js/solid.min.js"></script>
    <script defer src="https://sldn.softlayer.com/fontawesome/js/brands.min.js"></script>
    <script defer src="https://sldn.softlayer.com/fontawesome/js/fontawesome.min.js"></script>

    <script>
		$(document).ready(function() {
			$('table').addClass("table table-hover table-striped")
		})
	</script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-88235803-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
</head>

<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle Navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://sldn.softlayer.com/">SoftLayer API</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    
                        <li><a href="https://sldn.softlayer.com/article/">Articles</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/reference/softlayerapi">Documentation</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/go/">Go</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/java/">Java</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/perl/">Perl</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/php/">PHP</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/python/">Python</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/rest/">Rest</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/ruby/">Ruby</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/tools/">Tools</a></li>
                    

                    
                </ul>
                <div id="custom-search-input" class="pull-right">
                  <form class="navbar-form" role="search" method="get" action="https://www.bing.com/search">
                    <div class="input-group col-md-12">
                      <input type="text" class="form-control input-md" placeholder="Search" name="q" id="srch-term">
                      <input type="hidden" name="q1" value="site:sldn.softlayer.com" />
                      <div class="input-group-btn">
                        <button class="btn btn-info" type="submit">
                          <i class="glyphicon glyphicon-search"></i>
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
            </div>
        </div>
    </nav>

<div class="container">
    <div class="row">
    
        <div class="col-md-3">
            <div style="word-wrap: break-word;"> 
                <h4>September 13, 2017<br></h4>
            </div>
        </div>
        <div class="col-md-9">

                <strong>Classes <span class="fa fa-book"/></strong>
                
                    <a class="label label-primary" href="https://sldn.softlayer.com/reference/services/Swift">Swift</a>
                
                <br>
                <strong>Tags <span class="fa fa-tags"/></strong>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/swift">swift</a>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/tools">tools</a>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/template">template</a>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/deprecated">deprecated</a>
                          
        </div>
    </div>
    <hr>
    <div class="row">
		<div class="col-md-12">
            <div class="well well-sm  article" style="word-wrap: break-word;">
                <div class="article-title">
				    <h1>Object Storage Uploader</h1>
                    <small>Import customer-supplied Virtual Hard Disks (VHDs) to our object storage offering.</small>
                </div>
				
                
                    <div class="alert alert-info alert-dismissable" style="margin-top:25px;margin-bottom:5px;">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                        <strong>Hey, listen!</strong><br>
                        This example contains deprecated methods or syntax and needs to be updated. Please use caution when using.
                    </div>
                
				
                <h2 id="overview">Overview</h2>
<p>We’ve recently added the option to import customer-supplied Virtual Hard Disks (VHDs) to our object storage offering. This is a great option for our customers who may have special virtual machines that they have spent hours perfecting. Since learning to import these images can pose a slight challenge, especially for those unfamiliar with object storage (OpenStack Swift), I wrote this blog to share scripts that will streamline the process.</p>
<h2 id="object-storage">Object Storage</h2>
<p>SoftLayer’s object storage is an enhanced version of OpenStack Swift. Although we’ve added features to it, the API (on the whole) is still the same. Two requirements of particular importance to storing disk images are limitations and requirements on large files. Swift limits all files to be 5GB or less. To support larger files users need to create a manifest file that combines smaller files into one large file.</p>
<p>For example, to upload a 12GB VHD, the user is expected to segment the file into at least three files and then create a manifest that brings them back together.</p>
<h2 id="easier-importing">Easier Importing</h2>
<p>Since many people don’t have the time to learn the inner workings of Swift and would just like to get VHDs running on their servers, I have created a set scripts to simplify the process. They handle the authentication, file segmentation, and dynamic manifest creation for you, so you can get up and running quickly. You can easily access them here .</p>
<p>You can use a Bash script or a Python 3 script. Both do the same thing, but depending on your environment you may prefer one over the other.</p>
<p>But before we jump into the scripts, you’ll need to find your object storage username and password.</p>
<p>To get those, log in to <a href="http://control.softlayer.com">http://control.softlayer.com</a>, go to Storage-&gt;Object Storage, select your cluster (I would suggest Dallas 5 for your first tests), and then click “View Credentials” in the top left of the page. You will be presented with a modal window containing your username and API Key (or password) for object storage.</p>
<h2 id="objectstorageuploadersh---bash-edition">ObjectStorageUploader.sh - Bash Edition</h2>
<p>The idea behind this script is to have as little user interaction as possible. By calling the script with the proper parameters, you are able to walk away and let it do its thing.</p>
<p>Simply place the bash script in your directory of VHDs. Call the script by passing in the image you want to upload, the location to upload it (container/filename), and your Swift username and password.</p>
<p>$ ./ObjectStorageUpload.sh myOS.vhd &lsquo;myContainer/myOS.vhd&rsquo; &lsquo;SLOS1234-1:SL1234&rsquo; &lsquo;apikey&rsquo;</p>
<p>It will begin the process of walking through the segments of the file and building up your object in object storage.</p>
<h2 id="objectstorageuploaderpy---python-3-edition">ObjectStorageUploader.py - Python 3 Edition</h2>
<p>Before we begin, make sure you have installed the latest version of Python 3 located here: <a href="https://www.python.org/downloads/">https://www.python.org/downloads/</a></p>
<p>Any Python 3 release will work, but I have been using Python 3.4.0 for my testing.</p>
<p>The idea behind this script is to actually walk you through the process of uploading a file to Swift. Use this script via supplied parameters, in “interactive mode,” or a combination of the two. This is particularly handy for Windows users who are newer to scripting. Simply drop the script in the folder containing your VHDs, run it, and let it guide you through uploading the image to object storage.</p>
<p>To execute the script, place it in the directory where you store your VHDs and double click it. It will then prompt you to select the file you want to upload.</p>
<p>After selecting your file, you will be asked for your Swift username and password. Authentication will be attempted and, if successful, the list of containers in your cluster will be presented.</p>
<p>Select the container you want to upload to and the script will begin uploading the VHD to object storage.</p>
<p>If you prefer the command line arguments approach, you can pass in arguments to this script too. The signature is slightly different since all the opinions are optional.</p>
<p>$ python ObjectStorageUpload.py -f myOS.vhd -t &lsquo;myContainer/myOS.vhd&rsquo; -u &lsquo;SLOS1234-1:SL1234&rsquo;</p>
<h2 id="importing-uploaded-vhd-as-image-templates">Importing Uploaded VHD as Image Templates</h2>
<p>Now that your image is in object storage you can import your VHD into the SoftLayer template, so you can use it to provision a new virtual server!</p>
<p>Go to your image templates page in the portal and click the “Import Image” tab. Select the Swift account, cluster, container, and file that you uploaded. Give your new template a name and some notes. Make sure to fill out the Operating System information properly as this is used when setting up your new server, and finally click “Import.”</p>
<p>Lastly, you will be emailed after the VHD has been processed by our system.</p>
<p>-Adam Shaw</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># ================================================================================</span>
<span class="c1">#     ObjectStorageUploader.py</span>
<span class="c1">#     © Copyright IBM Corporation 2014.</span>
<span class="c1">#     LICENSE: MIT (http://opensource.org/licenses/MIT)    </span>
<span class="c1"># ================================================================================</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">http.client</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>



<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-f&#34;</span><span class="p">,</span> <span class="s2">&#34;--file&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;file to upload to SWIFT&#34;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-u&#34;</span><span class="p">,</span> <span class="s2">&#34;--username&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;SWIFT username&#34;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-p&#34;</span><span class="p">,</span> <span class="s2">&#34;--password&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;SWIFT password (SoftLayer API key)&#34;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span> <span class="s2">&#34;--cluster&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;SWIFT cluster to use (default: dal05.objectstorage.softlayer.net)&#34;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-t&#34;</span><span class="p">,</span> <span class="s2">&#34;--target&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;location on SWIFT cluster to store file (container/filename.vhd)&#34;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">select_file</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
        <span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span> <span class="o">=</span> <span class="n">get_swift_credentials</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">swift_user_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">username</span>
        <span class="n">swift_password</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
        <span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span> <span class="o">=</span> <span class="n">authenticate_swift</span><span class="p">(</span>
            <span class="n">swift_user_name</span><span class="p">,</span>
            <span class="n">swift_password</span><span class="p">,</span>
            <span class="s2">&#34;dal05.objectstorage.softlayer.net&#34;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span> <span class="o">=</span> <span class="n">authenticate_swift</span><span class="p">(</span>
            <span class="n">swift_user_name</span><span class="p">,</span>
            <span class="n">swift_password</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">cluster</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">select_container</span><span class="p">(</span><span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>
        <span class="n">swift_target_path</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">quote</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">swift_target_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">target</span>

    <span class="n">upload_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">swift_target_path</span><span class="p">,</span> <span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">select_file</span><span class="p">():</span>
    <span class="n">current_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Files in </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_path</span><span class="p">))</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_file_list</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prompt_for_choice</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s2">&#34;Select file for upload:&#34;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_file_list</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files</span>


<span class="k">def</span> <span class="nf">prompt_for_choice</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">prompt_label</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
    <span class="n">selected_index</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt_label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selected_index</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">selected_index</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">selected_index</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Invalid Input: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_index</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">prompt_for_choice</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">prompt_label</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_swift_credentials</span><span class="p">():</span>
    <span class="n">swift_user_name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Swift Username:&#34;</span><span class="p">)</span>
    <span class="n">swift_password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Swift Password:&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span>


<span class="k">def</span> <span class="nf">authenticate_swift</span><span class="p">(</span><span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span><span class="p">,</span> <span class="n">selected_endpoint</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">selected_endpoint</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">:</span>
        <span class="n">swift_endpoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&#34;dal05.objectstorage.softlayer.net&#34;</span><span class="p">,</span>
            <span class="s2">&#34;sng01.objectstorage.softlayer.net&#34;</span><span class="p">,</span>
            <span class="s2">&#34;ams01.objectstorage.softlayer.net&#34;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">selected_endpoint</span> <span class="o">=</span> <span class="n">prompt_for_choice</span><span class="p">(</span>
            <span class="n">swift_endpoints</span><span class="p">,</span>
            <span class="s2">&#34;Select Object Storage Endpoint:&#34;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Authenticating...&#34;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;X-Storage-User&#34;</span><span class="p">:</span> <span class="n">swift_user_name</span><span class="p">,</span>
        <span class="s2">&#34;X-Storage-Pass&#34;</span><span class="p">:</span> <span class="n">swift_password</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">object_storage_request</span><span class="p">(</span>
            <span class="n">selected_endpoint</span><span class="p">,</span>
            <span class="s2">&#34;/auth/v1.0/&#34;</span><span class="p">,</span>
            <span class="n">headers</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span> <span class="o">=</span> <span class="n">get_swift_credentials</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">authenticate_swift</span><span class="p">(</span><span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Success!&#34;</span><span class="p">)</span>

    <span class="n">storage_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s2">&#34;X-Storage-Url&#34;</span><span class="p">)</span>
    <span class="n">auth_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s2">&#34;X-Auth-Token&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span>


<span class="k">def</span> <span class="nf">select_container</span><span class="p">(</span><span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">):</span>
    <span class="n">url_tuple</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">storage_url</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;X-Auth-Token&#34;</span><span class="p">:</span> <span class="n">auth_token</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">object_storage_request</span><span class="p">(</span>
            <span class="n">url_tuple</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
            <span class="n">url_tuple</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">headers</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span> <span class="o">=</span> <span class="n">get_swift_credentials</span><span class="p">()</span>
        <span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span> <span class="o">=</span> <span class="n">authenticate_swift</span><span class="p">(</span><span class="n">swift_user_name</span><span class="p">,</span> <span class="n">swift_password</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">select_container</span><span class="p">(</span><span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>

    <span class="n">containers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prompt_for_choice</span><span class="p">(</span><span class="n">containers</span><span class="p">,</span> <span class="s2">&#34;Select Container:&#34;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">object_storage_request</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&#34;GET&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">):</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

    <span class="k">if</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Error </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">swift_target_path</span><span class="p">,</span> <span class="n">storage_url</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">):</span>
    <span class="n">url_tuple</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">storage_url</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;X-Auth-Token&#34;</span><span class="p">:</span> <span class="n">auth_token</span><span class="p">}</span>

    <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1048576</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">block_size</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">file_size</span> <span class="o">/</span> <span class="n">chunk_size</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Reading in file&#34;</span><span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Uploading </span><span class="si">{}</span><span class="s2"> to </span><span class="se">\&#34;</span><span class="si">{}</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">swift_target_path</span><span class="p">))</span>
    <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Uploading part </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>
            <span class="n">chunk_name</span> <span class="o">=</span> <span class="s2">&#34;chunk-</span><span class="si">{0:0&gt;5}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">object_storage_request</span><span class="p">(</span>
                <span class="n">url_tuple</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
                <span class="s2">&#34;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_tuple</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">swift_target_path</span><span class="p">,</span> <span class="n">chunk_name</span><span class="p">),</span>
                <span class="n">headers</span><span class="p">,</span>
                <span class="s2">&#34;PUT&#34;</span><span class="p">,</span>
                <span class="n">data</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;failed to upload chunk with exception &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">retry</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Writing manifest file&#34;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&#34;X-Auth-Token&#34;</span><span class="p">:</span> <span class="n">auth_token</span><span class="p">,</span>
            <span class="s2">&#34;X-Object-Manifest&#34;</span><span class="p">:</span> <span class="n">swift_target_path</span><span class="p">,</span>
            <span class="s2">&#34;Content-Length&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">object_storage_request</span><span class="p">(</span>
            <span class="n">url_tuple</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
            <span class="s2">&#34;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_tuple</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">swift_target_path</span><span class="p">),</span>
            <span class="n">headers</span><span class="p">,</span>
            <span class="s2">&#34;PUT&#34;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;File Uploaded!&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="c1"># ================================================================================</span>
<span class="c1">#     ObjectStorageUploader.sh</span>
<span class="c1">#     © Copyright IBM Corporation 2014.</span>
<span class="c1">#     LICENSE: MIT (http://opensource.org/licenses/MIT)    </span>
<span class="c1"># ================================================================================</span>

<span class="c1">#./objectstorageupload.sh dsl-4.4.10.iso &#39;myContainer/file.vhd&#39; &#39;SLOS1234-1:SL1234&#39; &#39;apikey&#39;</span>

<span class="nv">fileToUpload</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">swiftTargetPath</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">swiftUsername</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">swiftPassword</span><span class="o">=</span><span class="nv">$4</span>

<span class="nv">swiftEndpoint</span><span class="o">=</span><span class="s1">&#39;https://dal05.objectstorage.softlayer.net/auth/v1.0/&#39;</span>

<span class="nv">apiResponse</span><span class="o">=</span><span class="k">$(</span>curl -X GET -H <span class="s2">&#34;X-Storage-User: </span><span class="nv">$swiftUsername</span><span class="s2">&#34;</span> -H <span class="s2">&#34;X-Storage-Pass: </span><span class="nv">$swiftPassword</span><span class="s2">&#34;</span> -s -i <span class="nv">$swiftEndpoint</span><span class="k">)</span>
<span class="nv">swiftAuthToken</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$apiResponse</span><span class="s2">&#34;</span> <span class="p">|</span> grep <span class="s2">&#34;X-Auth-Token:&#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/X-Auth-Token: //g&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;\r&#39;</span><span class="k">)</span>
<span class="nv">swiftStorageUrl</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$apiResponse</span><span class="s2">&#34;</span> <span class="p">|</span> grep <span class="s2">&#34;X-Storage-Url:&#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/X-Storage-Url: //g&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;\r&#39;</span><span class="k">)</span>

<span class="nv">fileSize</span><span class="o">=</span><span class="k">$(</span>wc -c <span class="nv">$fileToUpload</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="nv">blockSize</span><span class="o">=</span><span class="m">1048576</span>
<span class="nb">let</span> <span class="nv">chunkSize</span><span class="o">=</span><span class="m">2048</span> <span class="c1">#2GB chunks</span>
<span class="nb">let</span> <span class="nv">chunks</span><span class="o">=(</span><span class="nv">$fileSize</span>/<span class="nv">$blockSize</span>+<span class="nv">$chunkSize</span>-1<span class="o">)</span>/<span class="nv">$chunkSize</span><span class="p">;</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;chunks<span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
   <span class="nb">printf</span> -v chunkName <span class="s2">&#34;chunk-%05d&#34;</span> <span class="nv">$i</span>
   <span class="nb">let</span> <span class="nv">skipChunk</span><span class="o">=</span><span class="nv">$i</span>*chunkSize

   dd <span class="k">if</span><span class="o">=</span><span class="nv">$fileToUpload</span> <span class="nv">bs</span><span class="o">=</span><span class="nv">$blockSize</span> <span class="nv">count</span><span class="o">=</span><span class="nv">$chunkSize</span> <span class="nv">skip</span><span class="o">=</span><span class="nv">$skipChunk</span> <span class="p">|</span> curl -X PUT -H <span class="s2">&#34;X-Auth-Token: </span><span class="nv">$swiftAuthToken</span><span class="s2">&#34;</span> --data-binary @- <span class="s2">&#34;</span><span class="nv">$swiftStorageUrl</span><span class="s2">/</span><span class="nv">$swiftTargetPath</span><span class="s2">/</span><span class="nv">$chunkName</span><span class="s2">&#34;</span>
<span class="k">done</span>

curl -X PUT -H <span class="s2">&#34;X-Auth-Token: </span><span class="nv">$swiftAuthToken</span><span class="s2">&#34;</span> -H <span class="s2">&#34;X-Object-Manifest: </span><span class="nv">$swiftTargetPath</span><span class="s2">&#34;</span> -H <span class="s2">&#34;Content-Length: 0&#34;</span> <span class="nv">$swiftStorageUrl</span>/<span class="nv">$swiftTargetPath</span>
</code></pre></div><p>Originally from <a href="https://sldn.softlayer.com/blog/ashaw/object-storage-uploader">SLDN</a></p>

            </div>
        </div>

    </div>
    <hr>
    <div class="row">
        <div class="row">
            <div class="col-md-6">
    <div class="well well-sm" style="word-wrap: break-word;"> 
        <strong>Feedback? <span class="fas fa-comment"/></strong>
            <p>
                If this article contains any error, or leaves any of your questions unanswered, please help us out by 
                opening up a github issue.<br>
                <a class="" href="https://github.com/softlayer/githubio_source/issues/new?title=Feedback%20for%20python%20-%20Object%20Storage%20Uploader&body=Feedback+regarding%3A%20https%3a%2f%2fsldn.softlayer.com%2fpython%2fswiftUploader%2f"> Open an issue</a>
                <i class="fab fa-github" alt="github"></i>
            </p>
    </div>
</div>
        </div>
    </div>
        <footer>
            <div class="row">
                <hr>
                <div class="col-sm-12">
                    <p>&copy; SoftLayer 2020<br>
                    Built with <a href="https://github.com/spf13/hugo">Hugo</a></p>
                </div>
            </div>
        </footer>
</div>

    <script src="https://sldn.softlayer.com/js/jquery.js"></script>
    <script src="https://sldn.softlayer.com/js/bootstrap.js"></script>
</body>
</html>
