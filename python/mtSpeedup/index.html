<!doctype html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SoftLayer API Examples, implementations, and release notes.">
    <meta name="author" content="SoftLayer">

    <title>Threads for improved API performance - https://sldn.softlayer.com/</title>
    <link rel="canonical" href="https://sldn.softlayer.com/python/mtSpeedup/">
        <link href="https://sldn.softlayer.com/css/main.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/bootstrap.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/custom.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/monokai.css" rel="stylesheet">
    <link href="https://sldn.softlayer.com/css/highlight/solarized_dark.css" rel="stylesheet">
    

    <script src="https://sldn.softlayer.com/js/highlight.pack.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="shortcut icon" href="https://sldn.softlayer.com/img/favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Lato" />
            

    <script src="https://sldn.softlayer.com/js/jquery-3.3.1.min.js"></script> 
    <script src="https://sldn.softlayer.com/js/sldn.js"></script>


    <link href="https://sldn.softlayer.com/fontawesome/css/fontawesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://sldn.softlayer.com/fontawesome/css/brands.min.css" rel="stylesheet" type="text/css">
    <link href="https://sldn.softlayer.com/fontawesome/css/solid.min.css" rel="stylesheet" type="text/css">
    
    <script defer src="https://sldn.softlayer.com/fontawesome/js/solid.min.js"></script>
    <script defer src="https://sldn.softlayer.com/fontawesome/js/brands.min.js"></script>
    <script defer src="https://sldn.softlayer.com/fontawesome/js/fontawesome.min.js"></script>

    <script>
        var head = document.getElementsByTagName('head')[0]
        var style = document.createElement('link')
        style.type = 'text/css'
        style.rel = 'stylesheet'
        style.id = "dark-theme"
        if (localStorage.getItem("dark-mode-theme") == "dark") {
            style.href = '/css/dark.css'
        } else {
            style.href = '/css/light.css'
        }
        head.append(style)
    </script>

    <script>
		$(document).ready(function() {
			$('table').addClass("table table-hover table-striped")
            setThemeMode(localStorage.getItem("dark-mode-theme") || "dark");
		})
	</script>
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9XPZ9ZBSJE"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9XPZ9ZBSJE');
        }
      </script>
</head>

<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="nav-container">
            <div class="navbar-header" style="width: 150px">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle Navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://sldn.softlayer.com/">SoftLayer API</a>
            </div>

            <div class="navbar-header" style="width: calc(100% - 350px)">
                <ul class="nav navbar-nav" style="width: 100%">
                    
                        <li><a href="https://sldn.softlayer.com/article/">Articles</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/reference/softlayerapi">Docs</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/go/">Go</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/java/">Java</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/php/">PHP</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/python/">Python</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/rest/">Rest</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/ruby/">Ruby</a></li>
                    
                        <li><a href="https://sldn.softlayer.com/tools/">Tools</a></li>
                    
                    <li class="nav-item">
                        <a id="dark-toggle" class="dark-mode-toggle" aria-label="dark-mode-toggle" style="color: var(--Red); font-size: 20px">
                            <i class="fas fa-sun"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <div id="custom-search-input" class="pull-right" style="width: 200px">
              <form class="navbar-form" role="search" method="get" action="https://www.bing.com/search">
                <div class="input-group col-md-12">
                  <input type="text" class="form-control input-md" placeholder="Search" name="q" id="srch-term">
                  <input type="hidden" name="q1" value="site:sldn.softlayer.com" />
                  <div class="input-group-btn">
                    <button class="btn btn-info" type="submit">
                      <i class="glyphicon glyphicon-search"></i>
                    </button>
                  </div>
                </div>
              </form>
            </div>

        </div>
    </nav>

<script type="text/javascript">
const darkIconClass = 'fas fa-moon'
const lightIconClass = 'fas fa-sun'
var darkCSS = $("#dark-theme");
var darkToggleIcon = $("#dark-toggle i");




function setThemeMode(mode) {
    localStorage.setItem("dark-mode-theme", mode);
    if (mode === "dark") {
        darkToggleIcon.attr('class', darkIconClass)
    } else  {
        darkToggleIcon.attr('class', lightIconClass)
    }
}


$("#dark-toggle").click(function () {
  if (darkToggleIcon.attr("class") == lightIconClass) {
    setThemeMode("dark")
  } else if (darkToggleIcon.attr("class") == darkIconClass) {
    setThemeMode("light")
  }
  location.reload();
});
</script>
<div class="container">
    <div class="row">
    
        <div class="col-md-3">
            <div style="word-wrap: break-word;"> 
                <h4>October 16, 2023<br></h4>
            </div>
        </div>
        <div class="col-md-9">

                <strong>Classes <span class="fa fa-book"/></strong>
                
                    <a class="label label-primary" href="https://sldn.softlayer.com/reference/services/SoftLayer_Account">SoftLayer_Account</a>
                
                <br>
                <strong>Tags <span class="fa fa-tags"/></strong>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/article">article</a>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/examples">examples</a>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/objectfilter">objectfilter</a>
                
                    <a class="label label-danger" href="https://sldn.softlayer.com/tags/slcli">slcli</a>
                          
        </div>
    </div>
    <hr>
    <div class="row">
		<div class="col-md-12">
            <div class="well well-sm  article" style="word-wrap: break-word;">
                <div class="article-title">
				    <h1>Threads for improved API performance</h1>
                    <small>Describes how to use Python&#39;s Thread library to improve how quickly API commands can be executed by doing them in parallel instead of in series.</small>
                </div>
				
                
				
                <h1 id="basic-of-threads">Basic of Threads</h1>
<p>If you are unfamiliar with Threads, these examples will use the <a href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures">concurrent.futures</a> library within python (available after python3.2) which is fairly simple to get setup. I wont really go over HOW it works on a technical level, only how to best use it threads to improve performance when making SoftLayer API requests.</p>
<p>For some technical details on how python handles Threads the following are good reading on the topic</p>
<ul>
<li><a href="https://youtu.be/IEEhzQoKtQU?si=5F9NvQcf6km9QHan">Python Threading Tutorial: Run Code Concurrently Using the Threading Module</a></li>
<li><a href="https://realpython.com/intro-to-python-threading/">An Intro to Threading in Python</a></li>
<li><a href="https://www.packetswitch.co.uk/what-is-concurrent-futures-and-how-can-it-boost-your-python-performance/">What Is Python concurrent.futures? (with examples)</a></li>
</ul>
<p>The basic pattern will look something like this</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">concurrent.futures</span> <span class="k">as</span> <span class="nn">cf</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">SoftLayer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">SoftLayer</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Adds this API call to the ThreadPool, to be executed at some point in the future</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_call</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getObject&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">id</span><span class="o">=</span><span class="mi">9999</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s2">&#34;mask[id,hostname]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Waits for the API call to return, then prints out the result</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">api_call</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</span></span></code></pre></div><p>With regards to the SoftLayer API, threads are useful in three situations. First is Pagination, when you make a series of identical API calls with a <a href="https://sldn.softlayer.com/article/using-result-limits-softlayer-api/">resultLimit</a> to get chunks of data from a long list of results. Instead of making 1 api call, then another and another, you can make them all at the same time (up to your max_works limit). Second, threads are great to break up a single API call that might take a long time to complete, into multiple smaller api calls that each execute quickly, thus making the overall execution time faster. Third is a sort of combination of the two previous. You will make a single API call to get a large list of Ids, then threads to pull each individual item and the verbose details you want about it.</p>
<h1 id="threads-for-pagination">Threads for Pagination</h1>
<p><a href="https://github.com/softlayer/softlayer-python/releases/tag/v6.2.0">softlayer-python v6.2.0</a> implements a new feature to easily enable threaded API calls to page through data in the client.cf_call() method. Here is that code and I will explain a bit on how it works.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cf_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Uses threads to iterate through API calls.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param service: the name of the SoftLayer API service
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param method: the method to call on the service
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param integer limit: result size for each API call (defaults to 100)
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param </span><span class="se">\\</span><span class="s2">*args: same optional arguments that ``Service.call`` takes
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param </span><span class="se">\\</span><span class="s2">*</span><span class="se">\\</span><span class="s2">*kwargs: same optional keyword arguments that ``Service.call`` takes
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&#34;Limit size should be greater than zero.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># This initial API call is to determine how many API calls we need to make after this first one.</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># This was not a list result, just return it.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_call</span><span class="p">,</span> <span class="n">transports</span><span class="o">.</span><span class="n">SoftLayerListResult</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">first_call</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># How many more API calls we have to make</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_calls</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">first_call</span><span class="o">.</span><span class="n">total_count</span> <span class="o">-</span> <span class="n">limit</span><span class="p">)</span> <span class="o">/</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">this_api</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Used to easily call executor.map() on this fuction&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">future_results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">api_calls</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">future_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">this_api</span><span class="p">,</span> <span class="n">offset_map</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Append the results in the order they were called</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">call_result</span> <span class="ow">in</span> <span class="n">future_results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">first_call</span> <span class="o">=</span> <span class="n">first_call</span> <span class="o">+</span> <span class="n">call_result</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">first_call</span>
</span></span></code></pre></div><p>First, we need to get (or set a default) for the <code>limit</code> and <code>offset</code> properties.</p>
<p>This removes them from the kwargs (if any other properties like mask/filter are set, we keep those), and will set them to a default value if they do not exist.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">limit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>From there, we need to make the first api call so we can determine how many total results we have to get. API results will have a special header called <code>softlayer-total-items</code> that we make use of here for that count. If the result is a List, the transport will set the result to a transports.SoftLayerListResult that has the <code>total_count</code> property with this header in it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">first_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This was not a list result, just return it.</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_call</span><span class="p">,</span> <span class="n">transports</span><span class="o">.</span><span class="n">SoftLayerListResult</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">first_call</span>
</span></span><span class="line"><span class="cl"><span class="c1"># How many more API calls we have to make</span>
</span></span><span class="line"><span class="cl"><span class="n">api_calls</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">first_call</span><span class="o">.</span><span class="n">total_count</span> <span class="o">-</span> <span class="n">limit</span><span class="p">)</span> <span class="o">/</span> <span class="n">limit</span><span class="p">)</span>
</span></span></code></pre></div><p>Once we have <code>total_count</code>, we subtract the <code>limit</code> (we don&rsquo;t want to get those results again), and divide by the limit (rounding up to the nearest whole number), and that gives us the count of how many API calls to make.</p>
<p>Next we need to define a small function we can use with the ThreadPoolExecutor to make things a little easier. The only variable that changes here is the offset, so that is our only parameter. The rest are set to whatever was passed in originally.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">this_api</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Used to easily call executor.map() on this fuction&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></div><p>Then we add the function calls to the ThreadPoolExecutor as follows</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">api_calls</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">future_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">this_api</span><span class="p">,</span> <span class="n">offset_map</span><span class="p">))</span>
</span></span></code></pre></div><p><code>offset_map</code> is just a list of ints we will pass into our <code>this_api</code> function, defining our offset. We start at <code>1 * limit</code> since we already have the <code>0 -&gt; limit</code> results from our first api call. <a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">Executor.map()</a> will add a call to <code>this_api()</code> for each element in <code>offset_map</code></p>
<p>Finally we leave the <code>with cf.ThreadPoolExecutor</code> block once all the API calls have executed, and we can simply add them together and return the result.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">call_result</span> <span class="ow">in</span> <span class="n">future_results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_call</span> <span class="o">=</span> <span class="n">first_call</span> <span class="o">+</span> <span class="n">call_result</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">first_call</span>
</span></span></code></pre></div><h1 id="threads-for-large-api-calls">Threads for large API calls</h1>
<p>For API calls that get a single resources (for example, SoftLayer_Hardware_Server::GetObject()), it can still be possible to use threading to improve performance if you are getting a lot of relational properties about the object. The function <a href="https://github.com/softlayer/softlayer-python/blob/master/SoftLayer/managers/hardware.py#L281">get_hardware_fast()</a> is a good example of this pattern.</p>
<p>The basic process is to remove any relational properties from your object mask that have corresponding methods, and call those methods instead.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_hardware_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hardware_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Get details about a hardware device. Similar to get_hardware() but this uses threads
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param integer id: the hardware ID
</span></span></span><span class="line"><span class="cl"><span class="s2">    :returns: A dictionary containing a large amount of information about the specified server.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">hw_mask</span> <span class="o">=</span> <span class="s2">&#34;mask[id, globalIdentifier, fullyQualifiedDomainName, hostname, domain]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getObject&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">hw_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">networkComponents</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getNetworkComponents&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">activeComponents</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getActiveComponents&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">activeTransaction</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getActiveTransaction&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">operatingSystem</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getOperatingSystem&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">softwareComponents</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getSoftwareComponents&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">billingItem</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getBillingItem&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">networkVlans</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getNetworkVlans&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">remoteManagementAccounts</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="s1">&#39;SoftLayer_Hardware_Server&#39;</span><span class="p">,</span> <span class="s1">&#39;getRemoteManagementAccounts&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">hardware_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;networkComponents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">networkComponents</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;activeComponents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activeComponents</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;activeTransaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activeTransaction</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;operatingSystem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operatingSystem</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;softwareComponents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">softwareComponents</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;billingItem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">billingItem</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;networkVlans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">networkVlans</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;remoteManagementAccounts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remoteManagementAccounts</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">[</span><span class="s1">&#39;tagReferences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tagReferences</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">server</span>
</span></span></code></pre></div><p>So instead of having <code>networkComponents</code> in the Hardware_Server objectMask, you remove it and make its own API call to <code>Hardware_Server::getNetworkComponents</code>, and put the result in the <code>networkComponents</code> property of the Hardware_Server object. Then do the same for all the other properties as shown above.</p>
<p>This can overall be faster than a single API call because with all the properties we are selecting originally, the database has to join in quite a few different tables and that can be very complex for the database. However each individual query is much simpler and can be returned very quickly. Since we are making all the seperate calls at the same time, the overall API execution time is much faster.</p>
<p>For this specific example, getting all the relational properties in a single api call takes about 4-9s. When breaking it up, each api call takes about 1-2s, and since they execute all at the same time, our overall execution time is just a bit over 2s.</p>
<h1 id="threads-for-two-stage-api-calls">Threads for two stage API calls</h1>
<p>For this pattern, we will get a list of object Ids with one api call, then use Threads to get the details of each of those Ids. For example, instead of using SoftLayer_Account::getVirtualGuests to get all the details about all of the Virtual_Guests on your account, you would use SoftLayer_Account::getVirtualGuests to simply get the Ids of each guest, then a bunch of calls to SoftLayer_Virtual_Guest::getObject(id=guest_id) to get all of the details. For accounts with a large number of guests this can be quite a lot faster than a single API call.</p>
<p><a href="https://github.com/softlayer/softlayer-python/blob/master/SoftLayer/CLI/bandwidth/pools.py#L48">slcli bandwidth pools</a> is a good example of this pattern. First it gets all the bandwidth pool Ids, then uses threads to get the information about each pool (which can be a fairly long API call).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize the AccountManager</span>
</span></span><span class="line"><span class="cl">    <span class="n">manager</span> <span class="o">=</span> <span class="n">AccountManager</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Get a lit of bandwidth pools, including the ID</span>
</span></span><span class="line"><span class="cl">    <span class="n">items</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_bandwidth_pools</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Setup ThreadPool</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">cf</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># List of pool ids, to be passed into AccountManager.get_bandwidth_pool_counts()</span>
</span></span><span class="line"><span class="cl">        <span class="n">item_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Builds the map, returning a tuple of the item, and the result of manager.get_bandwidth_pool_counts</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">servers</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">get_bandwidth_pool_counts</span><span class="p">,</span> <span class="n">item_ids</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">id_bandwidth</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">id_bandwidth</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">servers</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div>
            </div>
        </div>

    </div>
    <hr>
    <div class="row">
        <div class="row">
            <div class="col-md-6">
    <div class="well well-sm footer" style="word-wrap: break-word;"> 
        <strong>Feedback? <span class="fas fa-comment"/></strong>
            <p>
                If this article contains any error, or leaves any of your questions unanswered, please help us out by 
                opening up a github issue.<br>
                <a class="" href="https://github.com/softlayer/githubio_source/issues/new?title=Feedback%20for%20python%20-%20Threads%20for%20improved%20API%20performance&body=Feedback+regarding%3A%20https%3a%2f%2fsldn.softlayer.com%2fpython%2fmtSpeedup%2f"> Open an issue</a>
                <i class="fab fa-github" alt="github"></i>
                <span> - </span>
                <a class="" href="https://github.com/softlayer/githubio_source/edit/master/content/python/mtSpeedup.md" style="text-align: right;"> Quick Edit</a>
                <i class="fab fa-github" alt="github"></i>

            </p>
    </div>
</div>

        </div>
    </div>
<footer>
    <div class="row">
        <div class="col-sm-12 footer">
            <p>&copy; SoftLayer 2025<br>
            Built with <a href="https://github.com/spf13/hugo">Hugo</a></p>
        </div>
    </div>
</footer>
</div>

    <script src="https://sldn.softlayer.com/js/jquery.js"></script>
    <script src="https://sldn.softlayer.com/js/bootstrap.js"></script>
</body>
</html>
